# 変化点管理台帳登録画面 要件定義書

## 1. 画面概要

### 1.1 画面名
変化点管理台帳登録画面

### 1.2 画面の目的
TC_変化点管理台帳への新規データ登録および既存データの編集を行う。

### 1.3 画面タイプ
マルチステップフォーム（3ステップ構成）

## 2. 画面構成

### 2.1 画面レイアウト
- **ヘッダー部**: 画面タイトル「変化点管理台帳 登録」
- **プログレスバー**: 3ステップの進捗表示
- **入力フォーム部**: 各ステップの入力項目
- **ナビゲーション部**: 前へ/次へ/登録実行ボタン

### 2.2 ステップ構成
1. **ステップ1**: 基本情報の登録
2. **ステップ2**: 詳細情報の登録
3. **ステップ3**: 関連情報の登録

## 3. 入力項目定義

### 3.1 ステップ1: 基本情報の登録

#### 3.1.1 キー情報
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 工務受付No | [受付NO] | nvarchar | × | テキスト | 最大20文字 | 例: K2025-001 |
| 変化点No | [変化点NO] | nvarchar(20) | ○ | テキスト+自動付番ボタン | HPC形式チェック | HPC年2桁-4桁連番 |

#### 3.1.2 分類・区分
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 工務区分 | [KH工務区分] | nvarchar | ○ | ドロップダウン | - | 工程変更/設計変更等 |
| 起票部署 | [起票部署] | nvarchar(50) | ○ | テキスト | 最大50文字 | 部署名入力 |
| 管轄 | [KH管轄] | nvarchar | × | ドロップダウン | - | 管轄部署選択 |

#### 3.1.3 製品情報
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 品番 | [KH品番] | nvarchar(50) | ○ | テキスト | 最大50文字 | 製品番号 |
| 品名 | [KH品名] | nvarchar(100) | ○ | テキスト | 最大100文字 | 製品名称 |
| 素性 | [素性] | nvarchar(20) | × | ドロップダウン | - | 変更種別 |
| 製品ランク | [製品ランク] | nvarchar | × | ドロップダウン | - | A/B/C等 |

#### 3.1.4 日付情報
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 起票日 | [KH起票日] | datetime | ○ | 日付ピッカー | 未来日不可 | YYYY/MM/DD |
| 受付日 | [受付日] | datetime | × | 日付ピッカー | - | YYYY/MM/DD |
| 発行月日 | [発行月日] | datetime | × | 日付ピッカー | - | YYYY/MM/DD |

### 3.2 ステップ2: 詳細情報の登録

#### 3.2.1 変更内容
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 変更内容 | 複数フィールド | - | ○ | チェックボックス（複数選択） | 最低1つ選択 | 下記参照 |
| 目的内容 | [目的内容] | nvarchar(255) | × | テキストエリア | 最大255文字 | 変更目的 |
| 変更内容詳細 | [変更内容] | nvarchar(255) | × | テキストエリア | 最大255文字 | 詳細説明 |

**変更内容チェックボックス項目**:
- 設備変更 → [KH変更内容設備]
- 検査機器変更 → [KH変更内容検査機器]
- 金型変更 → [KH変更内容金型]
- 治工具変更 → [KH変更内容冶工具]
- 製造条件変更 → [KH変更内容製造条件]
- 工程変更 → [KH変更内容工程]
- 製造場所変更 → [KH変更内容製造場所]
- 材料変更 → [KH変更内容材料]
- 副資材変更 → [KH変更内容副資材]
- 物流変更 → [KH変更内容物流]
- その他 → [KH変更内容その他]

#### 3.2.2 実施情報
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 実施期間 | [実施期間] | nvarchar | × | テキスト | - | 期間入力 |
| 切替時期 | [切替時期] | nvarchar | × | テキスト | - | 切替タイミング |
| 切替基準日 | [切替基準日] | datetime | × | 日付ピッカー | - | YYYY/MM/DD |
| 納入予定日 | [納入予定日] | datetime | × | 日付ピッカー | - | YYYY/MM/DD |

#### 3.2.3 評価・判定
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 流動可否 | [流動可否] | nvarchar | × | ラジオボタン | - | 可/否 |
| 工程変更実施可否 | [工程変更実施可否] | nvarchar | × | ラジオボタン | - | 可/否 |
| 初期管理解除可否 | [初期管理解除可否] | nvarchar | × | ラジオボタン | - | 可/否 |
| 特殊工程有無 | [KH特殊工程有無] | int | × | ラジオボタン | - | 有:1/無:2 |

### 3.3 ステップ3: 関連情報の登録

#### 3.3.1 担当者情報
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 担当者 | [KH担当] | nvarchar | × | テキスト | - | 担当者名 |
| 担当CODE | [KH担当CODE] | nvarchar | × | テキスト | - | 担当者コード |
| TEL | [KHTEL] | nvarchar | × | テキスト | 電話番号形式 | ハイフン含む |
| メールアドレス | [KHメールアドレス] | nvarchar | × | テキスト | メール形式 | @必須 |

#### 3.3.2 文書情報
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 連絡書NO | [連絡書NO] | nvarchar | × | テキスト | - | 連絡書番号 |
| 設変NO | [KH設変NO] | nvarchar | × | テキスト | - | 設計変更番号 |
| 回答書NO | [KH回答書NO] | nvarchar | × | テキスト | - | 回答書番号 |
| 品管受付NO | [品管受付NO] | nvarchar | × | テキスト | - | 品質管理受付番号 |

#### 3.3.3 備考・その他
| 項目名 | DBフィールド | データ型 | 必須 | 入力形式 | バリデーション | 備考 |
|--------|-------------|---------|------|----------|--------------|------|
| 備考 | [備考] | nvarchar | × | テキストエリア | - | 自由記述 |
| 工務備考 | [KH工務備考] | nvarchar | × | テキストエリア | - | 工務関連備考 |
| リンクフォルダパス | [リンクフォルダパス] | nvarchar | × | テキスト | パス形式 | 関連ファイルパス |
| 添付ファイル有無 | [添付ファイル有無] | nvarchar | × | チェックボックス | - | 有/無 |

## 4. 機能要件

### 4.1 自動付番機能
- **変化点No自動生成**: 
  - フォーマット: HPC + 年2桁 + "-" + 4桁連番
  - 例: HPC25-0001, HPC25-0002
  - 年が変わると連番は0001にリセット
  - データベースから同年の最大値を取得して+1

### 4.2 重複チェック機能
- **登録時の重複確認**:
  - 変化点Noの重複をチェック
  - 重複時は自動で新番号を生成
  - ユーザーに変更を通知

### 4.3 バリデーション
- **必須項目チェック**: ステップ移動時に実施
- **形式チェック**: メールアドレス、電話番号等
- **日付チェック**: 論理的な日付の整合性
- **文字数チェック**: 最大文字数の制限

### 4.4 ナビゲーション
- **前へボタン**: 前のステップへ戻る（入力値保持）
- **次へボタン**: 次のステップへ進む（バリデーション実行）
- **登録実行ボタン**: 最終ステップでのみ表示

## 5. 画面遷移

### 5.1 遷移フロー
```
ステップ1（基本情報）
    ↓ [次へ]
ステップ2（詳細情報）
    ↓ [次へ]
ステップ3（関連情報）
    ↓ [登録実行]
登録完了 → 一覧画面へ遷移
```

### 5.2 キャンセル処理
- 各ステップでキャンセル可能
- 確認ダイアログ表示
- キャンセル時は一覧画面へ遷移

## 6. エラー処理

### 6.1 入力エラー
- エラー項目を赤枠表示
- エラーメッセージを項目下部に表示
- フォーカスを最初のエラー項目へ移動

### 6.2 システムエラー
- データベース接続エラー
- セッションタイムアウト
- エラーダイアログ表示

## 7. 性能要件

### 7.1 レスポンスタイム
- ステップ間の遷移: 1秒以内
- 自動付番: 2秒以内
- 登録処理: 3秒以内

## 8. セキュリティ要件

### 8.1 入力値検証
- SQLインジェクション対策
- XSS対策
- パラメータバインディング使用

### 8.2 権限制御
- ログインユーザーのみアクセス可能
- 編集権限の確認

## 9. UI/UX要件

### 9.1 デザイン
- モダンなカード型レイアウト
- レスポンシブデザイン（最小幅1280px）
- マテリアルデザイン準拠

### 9.2 操作性
- タブキーでの項目移動
- Enterキーでの次項目移動
- 自動フォーカス制御

### 9.3 視覚的フィードバック
- プログレスバー表示
- 入力完了項目のチェックマーク
- ローディングスピナー

## 10. 実装技術

### 10.1 フロントエンド
- HTML5 + CSS3
- JavaScript (ES6+)
- Bootstrap 5
- 日付ピッカー: Flatpickr

### 10.2 バックエンド
- Flask (Python)
- SQLAlchemy ORM
- pymssql

### 10.3 API仕様
- **変化点No生成**: GET /api/generate_henkaiten_no
- **重複チェック**: POST /api/check_duplicate_no
- **登録処理**: POST /register

## 11. テスト要件

### 11.1 単体テスト
- 各バリデーション機能
- 自動付番機能
- 重複チェック機能

### 11.2 結合テスト
- ステップ間のデータ引き継ぎ
- データベース登録処理
- エラー処理

### 11.3 ユーザビリティテスト
- 入力操作の流れ
- エラーメッセージの適切性
- レスポンスタイム

## 12. 今後の拡張予定

### 12.1 機能追加
- ファイルアップロード機能
- 承認ワークフロー
- 変更履歴管理
- 一時保存機能

### 12.2 改善項目
- 入力補助機能（オートコンプリート）
- テンプレート機能
- 一括登録機能

## 改訂履歴

| 版数 | 日付 | 作成者 | 変更内容 |
|------|------|--------|----------|
| 1.0 | 2025/01/21 | Claude | 初版作成 |