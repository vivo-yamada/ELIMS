<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程変更一覧 - ELIMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.bootstrap5.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container-fluid {
            padding: 20px;
        }
        .main-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.1);
            padding: 30px;
            margin-top: 20px;
        }
        .page-title {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 3px solid #2196f3;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            border: none;
            transition: transform 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        .table-container {
            overflow-x: auto;
        }
        table.dataTable {
            width: 100% !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%) !important;
            border: none !important;
            color: white !important;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(33, 150, 243, 0.1);
            cursor: pointer;
        }
        /* 列幅調整用のスタイル */
        th {
            position: relative;
            user-select: none;
        }
        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            z-index: 1;
        }
        .resize-handle:hover {
            background-color: #2196f3;
        }
        .resizing {
            cursor: col-resize;
            user-select: none;
        }
        .btn-reset-columns {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container-fluid">
        <div class="main-card">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2" style="border-bottom: 3px solid #2196f3;">
                <h1 class="page-title mb-0" style="border-bottom: none;">
                    <i class="bi bi-list-ul"></i> 工程変更一覧
                </h1>
                <!-- 操作ボタン -->
                <div>
                    <button class="btn btn-secondary btn-reset-columns" onclick="resetColumnWidths()">
                        <i class="bi bi-arrow-clockwise"></i> 列幅リセット
                    </button>
                    <button class="btn btn-primary" onclick="location.href='/register'">
                        <i class="bi bi-plus-circle"></i> 新規登録
                    </button>
                </div>
            </div>

            <!-- フィルタセクション -->
            <div class="filter-section">
                <h5 class="mb-3">検索条件</h5>
                <form id="filterForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">変化点No</label>
                            <input type="text" class="form-control" id="filterHenkaitenNo" placeholder="例: HPC25">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">起票部署</label>
                            <input type="text" class="form-control" id="filterKihyoBusho" placeholder="部分一致">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">品番</label>
                            <input type="text" class="form-control" id="filterHinban" placeholder="部分一致">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">品名</label>
                            <input type="text" class="form-control" id="filterHinmei" placeholder="部分一致">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">担当者</label>
                            <input type="text" class="form-control" id="filterTanto" placeholder="部分一致">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">受付日（From）</label>
                            <input type="date" class="form-control" id="filterDateFrom">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">受付日（To）</label>
                            <input type="date" class="form-control" id="filterDateTo">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">流動可否</label>
                            <select class="form-select" id="filterRyudoKahi">
                                <option value="">全て</option>
                                <option value="可">可</option>
                                <option value="否">否</option>
                                <option value="保留">保留</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">工程変更実施可否</label>
                            <select class="form-select" id="filterKoteiHenkoJisshi">
                                <option value="">全て</option>
                                <option value="可">可</option>
                                <option value="否">否</option>
                                <option value="検討中">検討中</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> クリア
                        </button>
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                            <i class="bi bi-search"></i> 検索
                        </button>
                    </div>
                </form>
            </div>

            <!-- データテーブル -->
            <div class="table-container">
                <table id="dataTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>選択</th>
                            <th>変化点No</th>
                            <th>担当者</th>
                            <th>初品納入予定日</th>
                            <th>初品納入実績初</th>
                            <th>流動可否</th>
                            <th>工程変更実施可否</th>
                            <th>起票部署</th>
                            <th>品番</th>
                            <th>品名</th>
                            <th>納入予定日</th>
                            <th>設変出図予定日</th>
                            <th>設変出図実績日</th>
                            <th>変更内容</th>
                            <th>特採</th>
                            <th>判定</th>
                            <th>工程変更予定日</th>
                            <th>管理</th>
                            <th>工変受付No</th>
                            <th>速総番No</th>
                            <th>工変受付日</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">削除確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>選択したデータを削除してもよろしいですか？</p>
                    <p class="text-danger">この操作は取り消せません。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">削除</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
    <script>
        let dataTable;
        let selectedIds = [];
        let deleteTargetId = null;
        const COLUMN_WIDTH_STORAGE_KEY = 'elims_column_widths';

        $(document).ready(function() {
            initializeDataTable();
            loadData();
            initializeColumnResize();
        });

        function initializeDataTable() {
            dataTable = $('#dataTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json'
                },
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/api/changes/list',
                    type: 'POST',
                    data: function(d) {
                        // フィルタ条件を追加
                        d.filterHenkaitenNo = $('#filterHenkaitenNo').val();
                        d.filterKihyoBusho = $('#filterKihyoBusho').val();
                        d.filterHinban = $('#filterHinban').val();
                        d.filterHinmei = $('#filterHinmei').val();
                        d.filterTanto = $('#filterTanto').val();
                        d.filterDateFrom = $('#filterDateFrom').val();
                        d.filterDateTo = $('#filterDateTo').val();
                        d.filterRyudoKahi = $('#filterRyudoKahi').val();
                        d.filterKoteiHenkoJisshi = $('#filterKoteiHenkoJisshi').val();
                    },
                    error: function(xhr, error, thrown) {
                        console.error('データ取得エラー:', error);
                        alert('データの取得に失敗しました。');
                    }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `<input type="checkbox" class="form-check-input row-select" data-id="${row.ID}">`;
                        }
                    },
                    { data: '変化点NO' },
                    { data: 'KH担当' },
                    {
                        data: 'KH初品納入変更日',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    {
                        data: 'KH初品納入実績初',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    { data: '流動可否' },
                    { data: '工程変更実施可否' },
                    { data: '起票部署' },
                    { data: 'KH品番' },
                    { data: 'KH品名' },
                    {
                        data: '納入予定日',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    {
                        data: 'KH設変出図予定日',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    {
                        data: 'KH設変出図実績日',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    {
                        data: '変更内容',
                        render: function(data) {
                            if (data && data.length > 50) {
                                return `<span title="${data}">${data.substring(0, 50)}...</span>`;
                            }
                            return data || '';
                        }
                    },
                    {
                        data: '特採後の処置',
                        render: function(data) {
                            return data === 1 ? 'あり' : 'なし';
                        }
                    },
                    {
                        data: '流動判定日',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    {
                        data: '切替基準日',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    { data: 'KH管轄' },
                    { data: '受付NO' },
                    { data: '連絡書NO' },
                    {
                        data: '受付日',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString('ja-JP') : '';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <div class="action-buttons">
                                    <button class="btn btn-info btn-sm" onclick="viewDetail('${row.ID}')" title="詳細">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="editRecord('${row.ID}')" title="編集">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('${row.ID}')" title="削除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ],
                order: [[20, 'desc']], // 受付日の降順
                pageLength: 10,
                lengthMenu: [[5, 10, 20], [5, 10, 20]],
                dom: 'rt<"row"<"col-sm-6"i><"col-sm-6"p>><"row"<"col-sm-12"l>>',
                colReorder: true,
                scrollX: true,
                autoWidth: false,
                columnDefs: getColumnDefs(),
                language: {
                    info: "全 _TOTAL_ 件中 _START_ から _END_ まで表示",
                    infoEmpty: "0件中0から0まで表示",
                    infoFiltered: "(全 _MAX_ 件からフィルタ)",
                    lengthMenu: "_MENU_ 件表示",
                    paginate: {
                        first: "最初",
                        last: "最後",
                        next: "次へ",
                        previous: "前へ"
                    }
                }
            });

            // 行のダブルクリックイベント
            $('#dataTable tbody').on('dblclick', 'tr', function() {
                const data = dataTable.row(this).data();
                if (data) {
                    viewDetail(data.ID);
                }
            });

            // チェックボックスのイベント
            $('#dataTable').on('change', '.row-select', function() {
                const id = $(this).data('id');
                if ($(this).is(':checked')) {
                    if (!selectedIds.includes(id)) {
                        selectedIds.push(id);
                    }
                } else {
                    selectedIds = selectedIds.filter(item => item !== id);
                }
            });
        }

        function loadData() {
            dataTable.ajax.reload();
        }

        function applyFilters() {
            loadData();
        }

        function clearFilters() {
            $('#filterForm')[0].reset();
            loadData();
        }

        function viewDetail(id) {
            window.location.href = `/detail/${id}`;
        }

        function editRecord(id) {
            window.location.href = `/edit/${id}`;
        }

        function deleteRecord(id) {
            deleteTargetId = id;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        function confirmDelete() {
            if (!deleteTargetId) return;

            showLoading(true);
            $.ajax({
                url: `/api/changes/${deleteTargetId}`,
                type: 'DELETE',
                success: function(response) {
                    showLoading(false);
                    alert('削除が完了しました。');
                    loadData();
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                },
                error: function(xhr, status, error) {
                    showLoading(false);
                    alert('削除に失敗しました。');
                    console.error('Delete error:', error);
                }
            });
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // 列幅のデフォルト設定
        function getDefaultColumnWidths() {
            return [
                { index: 0, width: '50px' },   // 選択
                { index: 1, width: '120px' },  // 変化点No
                { index: 2, width: '100px' },  // 担当者
                { index: 3, width: '120px' },  // 初品納入予定日
                { index: 4, width: '120px' },  // 初品納入実績初
                { index: 5, width: '100px' },  // 流動可否
                { index: 6, width: '140px' },  // 工程変更実施可否
                { index: 7, width: '120px' },  // 起票部署
                { index: 8, width: '120px' },  // 品番
                { index: 9, width: '200px' },  // 品名
                { index: 10, width: '120px' }, // 納入予定日
                { index: 11, width: '130px' }, // 設変出図予定日
                { index: 12, width: '130px' }, // 設変出図実績日
                { index: 13, width: '200px' }, // 変更内容
                { index: 14, width: '80px' },  // 特採
                { index: 15, width: '100px' }, // 判定
                { index: 16, width: '130px' }, // 工程変更予定日
                { index: 17, width: '80px' },  // 管理
                { index: 18, width: '120px' }, // 工変受付No
                { index: 19, width: '120px' }, // 速総番No
                { index: 20, width: '120px' }, // 工変受付日
                { index: 21, width: '120px' }  // 操作
            ];
        }

        // 保存された列幅を取得
        function getSavedColumnWidths() {
            const saved = localStorage.getItem(COLUMN_WIDTH_STORAGE_KEY);
            return saved ? JSON.parse(saved) : null;
        }

        // 列幅を保存
        function saveColumnWidths(widths) {
            localStorage.setItem(COLUMN_WIDTH_STORAGE_KEY, JSON.stringify(widths));
        }

        // columnDefsを生成
        function getColumnDefs() {
            const savedWidths = getSavedColumnWidths();
            const widths = savedWidths || getDefaultColumnWidths();

            return widths.map(item => ({
                targets: item.index,
                width: item.width
            }));
        }

        // 列幅リサイズの初期化
        function initializeColumnResize() {
            let isResizing = false;
            let currentColumn = null;
            let startX = 0;
            let startWidth = 0;

            // リサイズハンドルを追加
            $('#dataTable thead th').each(function(index) {
                if (index < 22) { // 全列にハンドルを追加
                    $(this).append('<div class="resize-handle"></div>');
                }
            });

            // リサイズハンドルのマウスダウン
            $(document).on('mousedown', '.resize-handle', function(e) {
                e.preventDefault();
                e.stopPropagation();

                isResizing = true;
                currentColumn = $(this).parent();
                startX = e.pageX;
                startWidth = currentColumn.outerWidth();

                $('body').addClass('resizing');
            });

            // マウス移動
            $(document).on('mousemove', function(e) {
                if (!isResizing) return;

                const diff = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + diff);
                currentColumn.css('width', newWidth + 'px');

                // DataTablesの列幅も更新
                const columnIndex = currentColumn.index();
                dataTable.column(columnIndex).header().style.width = newWidth + 'px';
            });

            // マウスアップ
            $(document).on('mouseup', function(e) {
                if (!isResizing) return;

                isResizing = false;
                $('body').removeClass('resizing');

                // 列幅を保存
                const widths = [];
                $('#dataTable thead th').each(function(index) {
                    if (index < 22) {
                        widths.push({
                            index: index,
                            width: $(this).outerWidth() + 'px'
                        });
                    }
                });
                saveColumnWidths(widths);

                currentColumn = null;
            });
        }

        // 列幅リセット
        function resetColumnWidths() {
            if (confirm('列幅をデフォルトに戻しますか？')) {
                localStorage.removeItem(COLUMN_WIDTH_STORAGE_KEY);
                location.reload();
            }
        }
    </script>
</body>
</html>